<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Diet‑Pro</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(17,24,39,.78);
      --panel2:rgba(15,23,42,.78);
      --line:#1f2a44;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#111827;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, #111a33, var(--bg));
    }
    .container{max-width:1100px;margin:0 auto;padding:16px;}
    .header{
      position:sticky;top:10px;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:var(--panel);backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.25));
      box-shadow:0 10px 22px rgba(34,197,94,.18);
      flex:0 0 auto;
    }
    .title{font-weight:900;letter-spacing:.2px;}
    .subtitle{font-size:12px;color:var(--muted);line-height:1.3;margin-top:2px;}
    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .tab{
      border:1px solid var(--line);background:var(--btn);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:750;font-size:14px;
    }
    .tab[aria-selected="true"]{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.45);}
    .grid{display:grid;gap:14px;margin-top:14px;}
    @media(min-width:900px){.grid{grid-template-columns: 1.15fr .85fr;}}
    .card{
      border:1px solid var(--line);border-radius:var(--radius);
      background:var(--panel);
      padding:14px;
      box-shadow: var(--shadow);
    }
    h2{margin:0 0 10px 0;font-size:16px;}
    .muted{color:var(--muted);font-size:13px;line-height:1.45;}
    .hr{height:1px;background:var(--line);margin:12px 0;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .rowBetween{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);background:rgba(15,23,42,.85);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:800;
    }
    .btnPrimary{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.45);}
    .btnDanger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);}
    .btn:active{transform: translateY(1px);}
    .input, select{
      background:rgba(15,23,42,.92);border:1px solid var(--line);color:var(--text);
      padding:10px 12px;border-radius:12px;font-size:14px;outline:none;
      width:100%;
    }
    .label{font-size:12px;color:var(--muted);margin-bottom:6px;}
    .formGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media(max-width:520px){.formGrid{grid-template-columns:1fr;}}
    .kpi{display:grid;grid-template-columns: repeat(4, minmax(0,1fr));gap:10px;}
    @media(max-width:520px){.kpi{grid-template-columns: repeat(2, minmax(0,1fr));}}
    .kpiBox{
      padding:12px;border-radius:14px;border:1px solid var(--line);background:var(--panel2);
    }
    .kpiLabel{font-size:12px;color:var(--muted);}
    .kpiVal{font-size:18px;font-weight:900;margin-top:6px;}
    .small{font-size:12px;color:var(--muted);}
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted);white-space:nowrap;
    }
    .pillOk{border-color:rgba(34,197,94,.45);color:#c7f9d6;background:rgba(34,197,94,.08);}
    .pillWarn{border-color:rgba(245,158,11,.45);color:#fde7c3;background:rgba(245,158,11,.08);}
    .pillBad{border-color:rgba(239,68,68,.45);color:#fecaca;background:rgba(239,68,68,.08);}
    .dayList{display:grid;gap:10px;}
    .dayCard{
      border:1px solid var(--line);border-radius:14px;background:var(--panel2);
      padding:12px;
    }
    .dayCard:active{transform: translateY(1px);}
    .dayHead{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .mealList{display:grid;gap:8px;margin-top:10px;}
    .meal{
      border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(17,24,39,.7);
    }
    .mealHead{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
    .toast{
      border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.08);
      padding:10px 12px;border-radius:12px;color:#fde7c3;font-size:13px;
    }
    dialog{
      border:none; padding:0; border-radius: 16px; width:min(860px, 96vw);
      background:var(--panel); color:var(--text);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.55);}
    .modalBody{padding:14px;}
    .items{margin-top:10px;display:grid;gap:8px;}
    .itemRow{display:grid;grid-template-columns: 1fr 110px 60px;gap:8px;align-items:center;}
    @media(max-width:520px){.itemRow{grid-template-columns:1fr 100px 56px;}}
    .mono{font-variant-numeric: tabular-nums;}
    .footnote{font-size:12px;color:var(--muted);line-height:1.4;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Diet‑Pro</div>
          <div class="subtitle">Piano settimanale con macro, sgarro Sabato sera, modifiche libere, statistiche. Nessun server.</div>
        </div>
      </div>
      <div class="nav" role="tablist" aria-label="Navigazione">
        <button class="tab" id="tab-settimana" aria-selected="true">Settimana</button>
        <button class="tab" id="tab-impostazioni" aria-selected="false">Impostazioni</button>
        <button class="tab" id="tab-statistiche" aria-selected="false">Statistiche</button>
      </div>
    </div>

    <div class="grid" id="content"></div>
  </div>

  <dialog id="editor">
    <div class="modalBody">
      <div class="rowBetween">
        <h2 id="editorTitle">Modifica</h2>
        <button class="btn" id="closeEditor">Chiudi</button>
      </div>
      <div class="muted">
        Se un pasto ha “Sgarro” attivo, i suoi macro non vengono conteggiati. Preimpostato su <b>Sabato Cena</b>.
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn btnPrimary" id="addMeal">+ Aggiungi pasto</button>
      </div>
      <div class="mealList" id="mealList" style="margin-top:12px;"></div>
      <div class="hr"></div>
      <div class="footnote">
        I dati vengono salvati nel browser (localStorage). Se cancelli dati del sito, perdi lo storico.
      </div>
    </div>
  </dialog>

<script>
/* ============================
   DATI (alimenti + piano)
   ============================ */

const FOODS = [
  {"id":"pollo","name":"Petto di pollo","kcal":110,"p":23,"c":0,"f":1.5},
  {"id":"tacchino","name":"Fesa di tacchino","kcal":105,"p":24,"c":0,"f":1.0},
  {"id":"manzo_magro","name":"Manzo magro","kcal":140,"p":22,"c":0,"f":5},
  {"id":"tonno","name":"Tonno al naturale (sgocciolato)","kcal":116,"p":26,"c":0,"f":1},
  {"id":"salmone","name":"Salmone","kcal":208,"p":20,"c":0,"f":13},
  {"id":"uova","name":"Uova intere","kcal":143,"p":13,"c":1,"f":10},
  {"id":"albumi","name":"Albumi","kcal":52,"p":11,"c":0.7,"f":0.2},
  {"id":"fiocchi","name":"Fiocchi di latte","kcal":98,"p":11,"c":3.4,"f":4.3},
  {"id":"yogurt_greco","name":"Yogurt greco 0%","kcal":59,"p":10,"c":3.6,"f":0.4},
  {"id":"whey","name":"Proteine whey (polvere)","kcal":400,"p":80,"c":8,"f":6},
  {"id":"tofu","name":"Tofu","kcal":120,"p":13,"c":1.9,"f":7},
  {"id":"legumi","name":"Legumi cotti (mix)","kcal":120,"p":8,"c":20,"f":2},

  {"id":"riso","name":"Riso (crudo)","kcal":360,"p":7,"c":79,"f":0.7},
  {"id":"pasta","name":"Pasta (cruda)","kcal":350,"p":12,"c":72,"f":1.5},
  {"id":"pane","name":"Pane","kcal":265,"p":9,"c":49,"f":3.2},
  {"id":"avena","name":"Fiocchi d'avena","kcal":389,"p":17,"c":66,"f":7},
  {"id":"patate","name":"Patate","kcal":77,"p":2,"c":17,"f":0.1},
  {"id":"galletta","name":"Gallette di riso","kcal":380,"p":8,"c":80,"f":3},
  {"id":"banana","name":"Banana","kcal":89,"p":1.1,"c":23,"f":0.3},
  {"id":"mela","name":"Mela","kcal":52,"p":0.3,"c":14,"f":0.2},
  {"id":"frutti_bosco","name":"Frutti di bosco","kcal":50,"p":1,"c":12,"f":0.5},
  {"id":"miele","name":"Miele","kcal":304,"p":0.3,"c":82,"f":0},

  {"id":"olio","name":"Olio EVO","kcal":884,"p":0,"c":0,"f":100},
  {"id":"burro_arachidi","name":"Burro d'arachidi","kcal":588,"p":25,"c":20,"f":50},
  {"id":"mandorle","name":"Mandorle","kcal":579,"p":21,"c":22,"f":50},
  {"id":"noci","name":"Noci","kcal":654,"p":15,"c":14,"f":65},
  {"id":"avocado","name":"Avocado","kcal":160,"p":2,"c":9,"f":15},

  {"id":"verdure","name":"Verdure miste (insalata/verdure)","kcal":25,"p":1.5,"c":4,"f":0.2},
  {"id":"pomodori","name":"Pomodori","kcal":18,"p":0.9,"c":3.9,"f":0.2},
  {"id":"zucchine","name":"Zucchine","kcal":17,"p":1.2,"c":3.1,"f":0.3}
];

const DEFAULT = {
  targets: { kcal: 2300, p: 170, c: 250, f: 70, tolKcal: 80, tolP: 10, tolC: 15, tolF: 8 },
  week: [
    { dayName: "Lunedì", meals: [
      { name:"Colazione", free:false, items:[ {foodId:"avena",g:70}, {foodId:"yogurt_greco",g:250}, {foodId:"frutti_bosco",g:120} ] },
      { name:"Spuntino AM", free:false, items:[ {foodId:"banana",g:120}, {foodId:"whey",g:30} ] },
      { name:"Pranzo", free:false, items:[ {foodId:"riso",g:90}, {foodId:"pollo",g:180}, {foodId:"verdure",g:250}, {foodId:"olio",g:10} ] },
      { name:"Spuntino PM", free:false, items:[ {foodId:"fiocchi",g:200}, {foodId:"mandorle",g:15}, {foodId:"miele",g:10} ] },
      { name:"Cena", free:false, items:[ {foodId:"patate",g:350}, {foodId:"tonno",g:160}, {foodId:"verdure",g:250}, {foodId:"olio",g:10} ] }
    ]},
    { dayName: "Martedì", meals: [] },
    { dayName: "Mercoledì", meals: [] },
    { dayName: "Giovedì", meals: [] },
    { dayName: "Venerdì", meals: [] },
    { dayName: "Sabato", meals: [] },
    { dayName: "Domenica", meals: [] }
  ]
};

// Copia lunedì sugli altri giorni, e sabato cena = sgarro
(function seedWeek(){
  const mon = DEFAULT.week[0].meals;
  for (let i=1;i<DEFAULT.week.length;i++){
    DEFAULT.week[i].meals = structuredClone(mon);
  }
  const sat = DEFAULT.week.find(d=>d.dayName==="Sabato");
  const idxDinner = sat.meals.findIndex(m=>m.name.toLowerCase().includes("cena"));
  if (idxDinner >= 0){
    sat.meals[idxDinner].name = "Cena (Sgarro)";
    sat.meals[idxDinner].free = true;
  }
})();

/* ============================
   STORAGE
   ============================ */
const KEY_STATE = "dietpro.single.v1";
const KEY_LOG   = "dietpro.single.log.v1";

function loadState(){
  try{
    const raw = localStorage.getItem(KEY_STATE);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}
function saveState(s){
  try{ localStorage.setItem(KEY_STATE, JSON.stringify(s)); }catch{}
}
function loadLog(){
  try{
    const raw = localStorage.getItem(KEY_LOG);
    return raw ? JSON.parse(raw) : {};
  }catch{ return {}; }
}
function saveLog(l){
  try{ localStorage.setItem(KEY_LOG, JSON.stringify(l)); }catch{}
}

/* ============================
   MACRO CALC
   ============================ */
const foodsById = new Map(FOODS.map(f=>[f.id,f]));

function macrosForItem(food, grams){
  const mult = (Number(grams)||0)/100;
  return { kcal: food.kcal*mult, p: food.p*mult, c: food.c*mult, f: food.f*mult };
}
function sumMacros(list){
  return list.reduce((a,x)=>({kcal:a.kcal+(x.kcal||0), p:a.p+(x.p||0), c:a.c+(x.c||0), f:a.f+(x.f||0)}), {kcal:0,p:0,c:0,f:0});
}
function dayTotals(day){
  const perMeal = day.meals.map(meal=>{
    if (meal.free) return { meal, totals:{kcal:0,p:0,c:0,f:0} };
    const items = meal.items || [];
    const macros = items.map(it=>{
      const food = foodsById.get(it.foodId);
      return food ? macrosForItem(food, it.g) : {kcal:0,p:0,c:0,f:0};
    });
    return { meal, totals: sumMacros(macros) };
  });
  return { totals: sumMacros(perMeal.map(x=>x.totals)), perMeal };
}
function withinTol(v,t,tol){ return Math.abs((Number(v)||0)-(Number(t)||0)) <= (Number(tol)||0); }
function dayOk(totals, targets){
  return withinTol(totals.kcal, targets.kcal, targets.tolKcal)
      && withinTol(totals.p, targets.p, targets.tolP)
      && withinTol(totals.c, targets.c, targets.tolC)
      && withinTol(totals.f, targets.f, targets.tolF);
}
function statusForDay(totals, targets){
  if (dayOk(totals, targets)) return "ok";
  const d = {
    kcal: Math.abs(totals.kcal-targets.kcal)-targets.tolKcal,
    p: Math.abs(totals.p-targets.p)-targets.tolP,
    c: Math.abs(totals.c-targets.c)-targets.tolC,
    f: Math.abs(totals.f-targets.f)-targets.tolF
  };
  const max = Math.max(d.kcal,d.p,d.c,d.f);
  return max <= Math.max(50, targets.tolKcal) ? "warn" : "bad";
}
const r0 = x => Math.round(x);
const r1 = x => Math.round((x + Number.EPSILON)*10)/10;
const isoToday = () => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
};
function weekdayIdx(date=new Date()){
  // JS: 0=Sunday. We want 0=Monday..6=Sunday
  const js = date.getDay();
  return (js+6)%7;
}

/* ============================
   UI STATE
   ============================ */
let state = loadState() || structuredClone(DEFAULT);
let log = loadLog();
let activeTab = "settimana";
let editingDayIdx = null;

const content = document.getElementById("content");
const tabWeek = document.getElementById("tab-settimana");
const tabSettings = document.getElementById("tab-impostazioni");
const tabStats = document.getElementById("tab-statistiche");

function setTab(t){
  activeTab = t;
  tabWeek.setAttribute("aria-selected", t==="settimana");
  tabSettings.setAttribute("aria-selected", t==="impostazioni");
  tabStats.setAttribute("aria-selected", t==="statistiche");
  render();
}

tabWeek.onclick = ()=>setTab("settimana");
tabSettings.onclick = ()=>setTab("impostazioni");
tabStats.onclick = ()=>setTab("statistiche");

/* ============================
   RENDER HELPERS
   ============================ */
function pill(status, text){
  const cls = status==="ok" ? "pill pillOk" : (status==="warn" ? "pill pillWarn" : "pill pillBad");
  return `<span class="${cls}">${text}</span>`;
}
function kpiBox(label, val, target, tol){
  const diff = val - target;
  const ok = Math.abs(diff) <= tol;
  const st = ok ? "ok" : (Math.abs(diff) <= tol*2 ? "warn" : "bad");
  const badge = ok ? "OK" : (diff>0 ? `+${r1(diff)}` : `${r1(diff)}`);
  return `
    <div class="kpiBox">
      <div class="kpiLabel">${label}</div>
      <div class="kpiVal mono">${val}</div>
      <div class="rowBetween" style="margin-top:6px;">
        <div class="small">Target: <span class="mono">${target}</span> ± <span class="mono">${tol}</span></div>
        ${pill(st, badge)}
      </div>
    </div>
  `;
}
function summaryWeek(){
  const days = state.week.map(d=>{
    const totals = dayTotals(d).totals;
    const ok = dayOk(totals, state.targets);
    const st = statusForDay(totals, state.targets);
    return { day:d, totals, ok, st };
  });
  return {
    days,
    okDays: days.filter(x=>x.ok).length,
    totalDays: days.length,
    todayIdx: weekdayIdx(new Date()),
  };
}

/* ============================
   MAIN RENDER
   ============================ */
function render(){
  saveState(state);
  saveLog(log);

  const wk = summaryWeek();
  const today = wk.days[wk.todayIdx] || wk.days[0];
  const totalsToday = today ? today.totals : {kcal:0,p:0,c:0,f:0};

  const leftCard = `
    <div class="card">
      <h2>Riepilogo (oggi)</h2>
      <div class="muted">
        I macro sono calcolati escludendo i pasti con “Sgarro”. Preimpostato su Sabato Cena.
      </div>
      <div class="hr"></div>

      <div class="kpi">
        ${kpiBox("Kcal", r0(totalsToday.kcal), state.targets.kcal, state.targets.tolKcal)}
        ${kpiBox("Proteine", r1(totalsToday.p), state.targets.p, state.targets.tolP)}
        ${kpiBox("Carbo", r1(totalsToday.c), state.targets.c, state.targets.tolC)}
        ${kpiBox("Grassi", r1(totalsToday.f), state.targets.f, state.targets.tolF)}
      </div>

      <div class="hr"></div>
      <div class="rowBetween">
        <div class="muted">
          Oggi: <b>${today ? today.day.dayName : ""}</b> — ${pill(today ? today.st : "warn", today && today.ok ? "OK" : (today?.st==="warn"?"ATTENZIONE":"FUORI"))}
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn btnPrimary" id="markOk">Segna oggi OK</button>
          <button class="btn" id="markNo">Segna oggi NO</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="toast">
        Suggerimento operativo: imposta i macro in “Impostazioni”, poi modifica gli alimenti in “Settimana”.
      </div>
    </div>
  `;

  let rightCard = "";
  if (activeTab === "settimana"){
    rightCard = renderWeek(wk);
  } else if (activeTab === "impostazioni"){
    rightCard = renderSettings();
  } else {
    rightCard = renderStats(wk);
  }

  content.innerHTML = leftCard + rightCard;

  // bind buttons
  document.getElementById("markOk").onclick = ()=>{
    log[isoToday()] = { ok:true, at:new Date().toISOString() };
    render();
  };
  document.getElementById("markNo").onclick = ()=>{
    log[isoToday()] = { ok:false, at:new Date().toISOString() };
    render();
  };
}

function renderWeek(wk){
  const list = wk.days.map((x, idx)=>{
    const label = x.ok ? "OK" : (x.st==="warn" ? "ATTENZIONE" : "FUORI");
    return `
      <div class="dayCard" data-day="${idx}">
        <div class="dayHead">
          <div style="font-weight:900">${x.day.dayName}</div>
          ${pill(x.st, label)}
        </div>
        <div class="small mono" style="margin-top:8px">
          Totali: ${r0(x.totals.kcal)} kcal — P ${r1(x.totals.p)} — C ${r1(x.totals.c)} — F ${r1(x.totals.f)}
        </div>
      </div>
    `;
  }).join("");

  const card = `
    <div class="card">
      <h2>Settimana</h2>
      <div class="muted">
        Tocca una giornata per modificare pasti, alimenti e grammi. Puoi anche aggiungere/rimuovere pasti (colazione sì/no).
      </div>
      <div class="hr"></div>
      <div class="rowBetween">
        <div class="muted">Giorni OK (settimana): <b>${wk.okDays}</b> / ${wk.totalDays}</div>
        <button class="btn btnDanger" id="resetPlan">Reset piano</button>
      </div>
      <div class="hr"></div>
      <div class="dayList">${list}</div>
    </div>
  `;

  // defer binding via setTimeout after insert
  setTimeout(()=>{
    const resetBtn = document.getElementById("resetPlan");
    if (resetBtn) resetBtn.onclick = ()=>{
      if (confirm("Vuoi ripristinare il piano predefinito?")) {
        state = structuredClone(DEFAULT);
        render();
      }
    };
    document.querySelectorAll("[data-day]").forEach(el=>{
      el.onclick = ()=>openEditor(Number(el.getAttribute("data-day")));
    });
  }, 0);

  return card;
}

function renderSettings(){
  const t = state.targets;
  return `
    <div class="card">
      <h2>Impostazioni macro</h2>
      <div class="muted">Inserisci i macro del coach e le tolleranze (±). La “giornata OK” è entro tolleranze su kcal, P, C, F.</div>
      <div class="hr"></div>

      <div class="formGrid">
        <div>
          <div class="label">Kcal target</div>
          <input class="input mono" id="kcal" inputmode="numeric" value="${t.kcal}">
        </div>
        <div>
          <div class="label">Tolleranza kcal (±)</div>
          <input class="input mono" id="tolKcal" inputmode="numeric" value="${t.tolKcal}">
        </div>

        <div>
          <div class="label">Proteine (g)</div>
          <input class="input mono" id="p" inputmode="numeric" value="${t.p}">
        </div>
        <div>
          <div class="label">Tolleranza proteine (±g)</div>
          <input class="input mono" id="tolP" inputmode="numeric" value="${t.tolP}">
        </div>

        <div>
          <div class="label">Carboidrati (g)</div>
          <input class="input mono" id="c" inputmode="numeric" value="${t.c}">
        </div>
        <div>
          <div class="label">Tolleranza carbo (±g)</div>
          <input class="input mono" id="tolC" inputmode="numeric" value="${t.tolC}">
        </div>

        <div>
          <div class="label">Grassi (g)</div>
          <input class="input mono" id="f" inputmode="numeric" value="${t.f}">
        </div>
        <div>
          <div class="label">Tolleranza grassi (±g)</div>
          <input class="input mono" id="tolF" inputmode="numeric" value="${t.tolF}">
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn btnPrimary" id="saveTargets">Salva</button>
      </div>

      <div class="hr"></div>
      <div class="footnote">
        Nota: per semplicità questa versione non “autorigenera” il piano per chiudere perfettamente i macro.
        Modifica le porzioni nella settimana finché rientri nelle tolleranze.
      </div>
    </div>
  `;
}

function renderStats(wk){
  const entries = Object.entries(log || {}).sort((a,b)=>a[0].localeCompare(b[0]));
  const total = entries.length;
  const ok = entries.filter(([,v])=>v.ok).length;

  const byMonth = new Map();
  const byYear = new Map();
  for (const [d, v] of entries){
    const ym = d.slice(0,7);
    const y = d.slice(0,4);
    byMonth.set(ym, { ok:(byMonth.get(ym)?.ok||0)+(v.ok?1:0), total:(byMonth.get(ym)?.total||0)+1 });
    byYear.set(y, { ok:(byYear.get(y)?.ok||0)+(v.ok?1:0), total:(byYear.get(y)?.total||0)+1 });
  }
  const months = Array.from(byMonth.entries()).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,8);
  const years = Array.from(byYear.entries()).sort((a,b)=>b[0].localeCompare(a[0]));

  const monthsHtml = months.length ? months.map(([k,v])=>(
    `<div class="rowBetween" style="padding:6px 0"><span class="mono">${k}</span>${pill("ok", `${v.ok}/${v.total}`)}</div>`
  )).join("") : `<div class="muted">Nessun dato.</div>`;

  const yearsHtml = years.length ? years.map(([k,v])=>(
    `<div class="rowBetween" style="padding:6px 0"><span class="mono">${k}</span>${pill("ok", `${v.ok}/${v.total}`)}</div>`
  )).join("") : `<div class="muted">Nessun dato.</div>`;

  const card = `
    <div class="card">
      <h2>Statistiche</h2>
      <div class="muted">
        “Rispetto” = giornata entro tolleranze (kcal, P, C, F). I pasti “Sgarro” non vengono conteggiati.
      </div>

      <div class="hr"></div>

      <div class="rowBetween">
        <div>
          <div style="font-weight:900">Settimana attuale</div>
          <div class="small">Giorni OK: <b>${wk.okDays}</b> / ${wk.totalDays}</div>
        </div>
        <button class="btn btnDanger" id="resetLog">Azzera storico</button>
      </div>

      <div class="hr"></div>

      <div class="rowBetween">
        <div>
          <div style="font-weight:900">Storico</div>
          <div class="small">Totale registrati: <b>${total}</b> — OK: <b>${ok}</b></div>
        </div>
        <div class="small">Oggi: <span class="mono">${isoToday()}</span></div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:14px;align-items:flex-start">
        <div style="flex:1;min-width:240px">
          <div style="font-weight:900;margin-bottom:6px">Ultimi mesi</div>
          ${monthsHtml}
        </div>
        <div style="flex:1;min-width:240px">
          <div style="font-weight:900;margin-bottom:6px">Anni</div>
          ${yearsHtml}
        </div>
      </div>
    </div>
  `;

  setTimeout(()=>{
    const btn = document.getElementById("resetLog");
    if (btn) btn.onclick = ()=>{
      if (confirm("Vuoi azzerare lo storico?")) { log = {}; render(); }
    };
  }, 0);

  return card;
}

/* ============================
   EDITOR MODAL
   ============================ */
const dlg = document.getElementById("editor");
const editorTitle = document.getElementById("editorTitle");
const mealList = document.getElementById("mealList");
document.getElementById("closeEditor").onclick = ()=>dlg.close();
document.getElementById("addMeal").onclick = ()=>{
  if (editingDayIdx==null) return;
  state.week[editingDayIdx].meals.push({ name:"Nuovo pasto", free:false, items:[{foodId:FOODS[0].id,g:100}] });
  renderEditor();
  render(); // update week list
};

function openEditor(dayIdx){
  editingDayIdx = dayIdx;
  renderEditor();
  dlg.showModal();
}

function renderEditor(){
  const day = state.week[editingDayIdx];
  editorTitle.textContent = `Modifica: ${day.dayName}`;

  const html = day.meals.map((meal, mi)=>{
    const itemsHtml = (meal.items||[]).map((it, ii)=>{
      const options = FOODS.map(f=>`<option value="${f.id}" ${f.id===it.foodId?"selected":""}>${escapeHtml(f.name)}</option>`).join("");
      return `
        <div class="itemRow">
          <select class="input" data-mi="${mi}" data-ii="${ii}" data-field="foodId">${options}</select>
          <input class="input mono" inputmode="numeric" data-mi="${mi}" data-ii="${ii}" data-field="g" value="${it.g}">
          <button class="btn" data-mi="${mi}" data-ii="${ii}" data-action="rmItem">Elimina</button>
        </div>
      `;
    }).join("");

    return `
      <div class="meal">
        <div class="mealHead">
          <div class="row" style="flex:1;gap:8px;min-width:240px">
            <input class="input" data-mi="${mi}" data-field="name" value="${escapeAttr(meal.name)}" style="flex:1">
            <label class="row" style="gap:6px">
              <input type="checkbox" data-mi="${mi}" data-field="free" ${meal.free?"checked":""}>
              <span class="small">Sgarro</span>
            </label>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn" data-mi="${mi}" data-action="addItem">+ Alimento</button>
            <button class="btn btnDanger" data-mi="${mi}" data-action="rmMeal">Rimuovi pasto</button>
          </div>
        </div>
        <div class="items">${itemsHtml}</div>
      </div>
    `;
  }).join("");

  mealList.innerHTML = html;

  // bind changes
  mealList.querySelectorAll("[data-field]").forEach(el=>{
    el.onchange = (e)=>{
      const mi = Number(el.getAttribute("data-mi"));
      const ii = el.hasAttribute("data-ii") ? Number(el.getAttribute("data-ii")) : null;
      const field = el.getAttribute("data-field");
      if (field === "name"){
        state.week[editingDayIdx].meals[mi].name = el.value;
      } else if (field === "free"){
        state.week[editingDayIdx].meals[mi].free = el.checked;
      } else if (field === "foodId"){
        state.week[editingDayIdx].meals[mi].items[ii].foodId = el.value;
      } else if (field === "g"){
        state.week[editingDayIdx].meals[mi].items[ii].g = Number(el.value)||0;
      }
      saveState(state);
      render(); // refresh day totals
    };
  });

  mealList.querySelectorAll("[data-action]").forEach(btn=>{
    btn.onclick = ()=>{
      const action = btn.getAttribute("data-action");
      const mi = Number(btn.getAttribute("data-mi"));
      const ii = btn.hasAttribute("data-ii") ? Number(btn.getAttribute("data-ii")) : null;

      if (action === "addItem"){
        state.week[editingDayIdx].meals[mi].items.push({foodId:FOODS[0].id,g:100});
      } else if (action === "rmMeal"){
        state.week[editingDayIdx].meals.splice(mi,1);
      } else if (action === "rmItem"){
        state.week[editingDayIdx].meals[mi].items.splice(ii,1);
      }
      saveState(state);
      renderEditor();
      render();
    };
  });
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escapeAttr(s){
  return String(s).replaceAll("&","&amp;").replaceAll('"',"&quot;");
}

/* ============================
   SETTINGS BINDING (after render)
   ============================ */
const origRender = render;
render = function(){
  origRender();
  if (activeTab === "impostazioni"){
    const ids = ["kcal","tolKcal","p","tolP","c","tolC","f","tolF"];
    const inputs = Object.fromEntries(ids.map(id=>[id, document.getElementById(id)]));
    const saveBtn = document.getElementById("saveTargets");
    if (saveBtn){
      saveBtn.onclick = ()=>{
        const t = state.targets;
        for (const id of ids){
          t[id] = Number(inputs[id].value)||0;
        }
        saveState(state);
        alert("Macro salvati.");
        render();
      };
    }
  }
};

/* START */
render();
</script>
</body>
</html>
