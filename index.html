<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Diet-Pro</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(17,24,39,.82);
      --panel2:rgba(15,23,42,.82);
      --line:#1f2a44;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#111827;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, #111a33, var(--bg));
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }
    .container{max-width:1100px;margin:0 auto;padding:16px;padding-bottom:40px;}
    .header{
      position:sticky;top:10px;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:var(--panel);backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.25));
      box-shadow:0 10px 22px rgba(34,197,94,.18);
      flex:0 0 auto;
    }
    .title{font-weight:900;letter-spacing:.2px;}
    .subtitle{font-size:12px;color:var(--muted);line-height:1.3;margin-top:2px;}
    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .tab{
      border:1px solid var(--line);background:var(--btn);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:800;font-size:14px;
      min-height:42px;
    }
    .tab[aria-selected="true"]{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.45);}
    .grid{display:grid;gap:14px;margin-top:14px;}
    @media(min-width:900px){.grid{grid-template-columns: 1.15fr .85fr;}}
    .card{
      border:1px solid var(--line);border-radius:var(--radius);
      background:var(--panel);
      padding:14px;
      box-shadow: var(--shadow);
    }
    h2{margin:0 0 10px 0;font-size:16px;}
    .muted{color:var(--muted);font-size:13px;line-height:1.45;}
    .hr{height:1px;background:var(--line);margin:12px 0;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .rowBetween{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);background:rgba(15,23,42,.9);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:850;
      min-height:42px;
    }
    .btnPrimary{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.45);}
    .btnDanger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);}
    .btn:active{transform: translateY(1px);}
    .input, select, textarea{
      background:rgba(15,23,42,.92);border:1px solid var(--line);color:var(--text);
      padding:10px 12px;border-radius:12px;font-size:14px;outline:none;
      width:100%;
      min-height:42px;
    }
    textarea{min-height:84px;resize:vertical;}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px;}
    .formGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media(max-width:520px){.formGrid{grid-template-columns:1fr;}}
    .kpi{display:grid;grid-template-columns: repeat(4, minmax(0,1fr));gap:10px;}
    @media(max-width:520px){.kpi{grid-template-columns: repeat(2, minmax(0,1fr));}}
    .kpiBox{
      padding:12px;border-radius:14px;border:1px solid var(--line);background:var(--panel2);
    }
    .kpiLabel{font-size:12px;color:var(--muted);}
    .kpiVal{font-size:18px;font-weight:950;margin-top:6px;}
    .small{font-size:12px;color:var(--muted);}
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted);white-space:nowrap;
    }
    .pillOk{border-color:rgba(34,197,94,.45);color:#c7f9d6;background:rgba(34,197,94,.08);}
    .pillWarn{border-color:rgba(245,158,11,.45);color:#fde7c3;background:rgba(245,158,11,.08);}
    .pillBad{border-color:rgba(239,68,68,.45);color:#fecaca;background:rgba(239,68,68,.08);}
    .dayList{display:grid;gap:10px;}
    .dayCard{
      border:1px solid var(--line);border-radius:14px;background:var(--panel2);
      padding:12px;
    }
    .dayCard:active{transform: translateY(1px);}
    .dayHead{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .mealList{display:grid;gap:8px;margin-top:10px;}
    .meal{
      border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(17,24,39,.7);
    }
    .mealHead{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
    .toast{
      border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.08);
      padding:10px 12px;border-radius:12px;color:#fde7c3;font-size:13px;
    }
    dialog{
      border:none; padding:0; border-radius: 16px; width:min(920px, 96vw);
      background:var(--panel); color:var(--text);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.55);}
    .modalBody{padding:14px;}
    .items{margin-top:10px;display:grid;gap:8px;}
    .itemRow{display:grid;grid-template-columns: 1fr 110px 90px 56px;gap:8px;align-items:center;}
    @media(max-width:520px){.itemRow{grid-template-columns:1fr 96px 88px 52px;}}
    .mono{font-variant-numeric: tabular-nums;}
    .footnote{font-size:12px;color:var(--muted);line-height:1.4;}
    .suggestBox{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background: rgba(15,23,42,.6);
    }
    .suggestGrid{display:grid;gap:8px;margin-top:10px;}
    .suggestRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border:1px solid var(--line);border-radius:12px;background: rgba(17,24,39,.6);
    }
    .hero{
      display:grid;gap:12px;
      border:1px solid var(--line);border-radius:18px;
      background: linear-gradient(180deg, rgba(34,197,94,.12), rgba(15,23,42,.25));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .heroTop{
      position:relative;
      min-height:190px;
      background: rgba(15,23,42,.35);
    }
    .heroImg{
      position:absolute;inset:0;
      background-size:cover;background-position:center;
      filter: saturate(1.1) contrast(1.05);
      transform: scale(1.02);
    }
    .heroShade{
      position:absolute;inset:0;
      background: radial-gradient(900px 260px at 10% 0%, rgba(0,0,0,.0), rgba(0,0,0,.55));
    }
    .heroContent{
      position:relative;
      padding:14px 14px 12px 14px;
    }
    .heroTitle{font-size:20px;font-weight:950;letter-spacing:.2px;}
    .heroQuote{margin-top:8px;color:#dbeafe;font-size:13px;line-height:1.45;}
    .heroActions{padding:0 14px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);background:rgba(15,23,42,.7);
      padding:10px 12px;border-radius:999px;color:var(--muted);font-size:12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Diet-Pro</div>
          <div class="subtitle">Costanza, controllo, chiarezza. App-like su iOS, senza server.</div>
        </div>
      </div>
      <div class="nav" role="tablist" aria-label="Navigazione" id="navTabs">
        <button class="tab" id="tab-home" aria-selected="true">Home</button>
        <button class="tab" id="tab-settimana" aria-selected="false">Settimana</button>
        <button class="tab" id="tab-impostazioni" aria-selected="false">Impostazioni</button>
        <button class="tab" id="tab-statistiche" aria-selected="false">Statistiche</button>
      </div>
    </div>

    <div class="grid" id="content"></div>
  </div>

  <dialog id="editor">
    <div class="modalBody">
      <div class="rowBetween">
        <h2 id="editorTitle">Modifica</h2>
        <div class="row" style="gap:8px;">
          <button class="btn" id="addFoodInline">+ Nuovo alimento</button>
          <button class="btn" id="closeEditor">Chiudi</button>
        </div>
      </div>
      <div class="muted">
        “Sgarro” esclude quel pasto dai conteggi. Puoi spostarlo dove vuoi.
      </div>
      <div class="hr"></div>

      <div id="inlineFoodForm" style="display:none;">
        <div class="toast">Aggiungi alimento personalizzato (valori per 100g). Poi lo trovi nel menu a tendina.</div>
        <div class="hr"></div>
        <div class="formGrid">
          <div>
            <div class="label">Nome alimento</div>
            <input class="input" id="ifName" placeholder="Es. Pane integrale" />
          </div>
          <div>
            <div class="label">ID (opzionale)</div>
            <input class="input mono" id="ifId" placeholder="pane_integrale" />
          </div>
          <div>
            <div class="label">Kcal / 100g</div>
            <input class="input mono" id="ifKcal" inputmode="numeric" placeholder="250" />
          </div>
          <div>
            <div class="label">Proteine / 100g</div>
            <input class="input mono" id="ifP" inputmode="numeric" placeholder="10" />
          </div>
          <div>
            <div class="label">Carbo / 100g</div>
            <input class="input mono" id="ifC" inputmode="numeric" placeholder="50" />
          </div>
          <div>
            <div class="label">Grassi / 100g</div>
            <input class="input mono" id="ifF" inputmode="numeric" placeholder="5" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="ifSave">Salva alimento</button>
          <button class="btn" id="ifCancel">Annulla</button>
        </div>
        <div class="hr"></div>
      </div>

      <div class="row">
        <button class="btn btnPrimary" id="addMeal">+ Aggiungi pasto</button>
      </div>
      <div class="mealList" id="mealList" style="margin-top:12px;"></div>
      <div class="hr"></div>
      <div class="footnote">
        Tutto viene salvato sul dispositivo (localStorage). Se cancelli i dati del sito, perdi modifiche e storico.
      </div>
    </div>
  </dialog>

<script>
/* ============================
   DEFAULT (alimenti + piano)
   ============================ */

const DEFAULT_FOODS = [
  {"id":"pollo","name":"Petto di pollo","kcal":110,"p":23,"c":0,"f":1.5},
  {"id":"tacchino","name":"Fesa di tacchino","kcal":105,"p":24,"c":0,"f":1.0},
  {"id":"manzo_magro","name":"Manzo magro","kcal":140,"p":22,"c":0,"f":5},
  {"id":"tonno","name":"Tonno al naturale (sgocciolato)","kcal":116,"p":26,"c":0,"f":1},
  {"id":"salmone","name":"Salmone","kcal":208,"p":20,"c":0,"f":13},
  {"id":"uova","name":"Uova intere","kcal":143,"p":13,"c":1,"f":10},
  {"id":"albumi","name":"Albumi","kcal":52,"p":11,"c":0.7,"f":0.2},
  {"id":"fiocchi","name":"Fiocchi di latte","kcal":98,"p":11,"c":3.4,"f":4.3},
  {"id":"yogurt_greco","name":"Yogurt greco 0%","kcal":59,"p":10,"c":3.6,"f":0.4},
  {"id":"whey","name":"Proteine whey (polvere)","kcal":400,"p":80,"c":8,"f":6},
  {"id":"tofu","name":"Tofu","kcal":120,"p":13,"c":1.9,"f":7},
  {"id":"legumi","name":"Legumi cotti (mix)","kcal":120,"p":8,"c":20,"f":2},

  {"id":"riso","name":"Riso (crudo)","kcal":360,"p":7,"c":79,"f":0.7},
  {"id":"pasta","name":"Pasta (cruda)","kcal":350,"p":12,"c":72,"f":1.5},
  {"id":"pane","name":"Pane","kcal":265,"p":9,"c":49,"f":3.2},
  {"id":"avena","name":"Fiocchi d'avena","kcal":389,"p":17,"c":66,"f":7},
  {"id":"patate","name":"Patate","kcal":77,"p":2,"c":17,"f":0.1},
  {"id":"galletta","name":"Gallette di riso","kcal":380,"p":8,"c":80,"f":3},
  {"id":"banana","name":"Banana","kcal":89,"p":1.1,"c":23,"f":0.3},
  {"id":"mela","name":"Mela","kcal":52,"p":0.3,"c":14,"f":0.2},
  {"id":"frutti_bosco","name":"Frutti di bosco","kcal":50,"p":1,"c":12,"f":0.5},
  {"id":"miele","name":"Miele","kcal":304,"p":0.3,"c":82,"f":0},

  {"id":"olio","name":"Olio EVO","kcal":884,"p":0,"c":0,"f":100},
  {"id":"burro_arachidi","name":"Burro d'arachidi","kcal":588,"p":25,"c":20,"f":50},
  {"id":"mandorle","name":"Mandorle","kcal":579,"p":21,"c":22,"f":50},
  {"id":"noci","name":"Noci","kcal":654,"p":15,"c":14,"f":65},
  {"id":"avocado","name":"Avocado","kcal":160,"p":2,"c":9,"f":15},

  {"id":"verdure","name":"Verdure miste (insalata/verdure)","kcal":25,"p":1.5,"c":4,"f":0.2},
  {"id":"pomodori","name":"Pomodori","kcal":18,"p":0.9,"c":3.9,"f":0.2},
  {"id":"zucchine","name":"Zucchine","kcal":17,"p":1.2,"c":3.1,"f":0.3}
];

const DEFAULT_STATE = {
  ui: { started: false },
  hero: {
    title: "Oggi si fa bene. Anche se non perfetto.",
    quote: "La costanza batte la motivazione. Un pasto alla volta, una settimana alla volta.",
    photo: "" // dataURL
  },
  targets: { kcal: 2300, calTolPct: 10 },
  week: [
    { dayName: "Lunedì", meals: [
      { name:"Colazione", free:false, items:[ {foodId:"avena",g:70}, {foodId:"yogurt_greco",g:250}, {foodId:"frutti_bosco",g:120} ] },
      { name:"Spuntino AM", free:false, items:[ {foodId:"banana",g:120}, {foodId:"whey",g:30} ] },
      { name:"Pranzo", free:false, items:[ {foodId:"riso",g:90}, {foodId:"pollo",g:180}, {foodId:"verdure",g:250}, {foodId:"olio",g:10} ] },
      { name:"Spuntino PM", free:false, items:[ {foodId:"fiocchi",g:200}, {foodId:"mandorle",g:15}, {foodId:"miele",g:10} ] },
      { name:"Cena", free:false, items:[ {foodId:"patate",g:350}, {foodId:"tonno",g:160}, {foodId:"verdure",g:250}, {foodId:"olio",g:10} ] }
    ]},
    { dayName: "Martedì", meals: [] },
    { dayName: "Mercoledì", meals: [] },
    { dayName: "Giovedì", meals: [] },
    { dayName: "Venerdì", meals: [] },
    { dayName: "Sabato", meals: [] },
    { dayName: "Domenica", meals: [] }
  ]
};

// Duplica Lunedì sugli altri giorni e imposta sgarro su Sabato Cena (modificabile)
(function seedWeek(){
  const clone = (x)=> JSON.parse(JSON.stringify(x));
  const monMeals = DEFAULT_STATE.week[0].meals;
  for (let i=1;i<DEFAULT_STATE.week.length;i++){
    DEFAULT_STATE.week[i].meals = clone(monMeals);
  }
  const sat = DEFAULT_STATE.week.find(d=>d.dayName==="Sabato");
  const idxDinner = sat.meals.findIndex(m=>/cena/i.test(m.name));
  if (idxDinner >= 0){
    sat.meals[idxDinner].free = true;
    if (!/sgarro/i.test(sat.meals[idxDinner].name)) sat.meals[idxDinner].name = "Cena (Sgarro)";
  }
})();

/* ============================
   STORAGE
   ============================ */
const KEY_STATE = "dietpro.single.v3.state";
const KEY_LOG   = "dietpro.single.v3.log";
const KEY_FOODS = "dietpro.single.v3.foods";

function loadJson(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}
function saveJson(key, obj){
  try{ localStorage.setItem(key, JSON.stringify(obj)); }catch{}
}

function loadFoods(){
  const saved = loadJson(KEY_FOODS);
  if (!Array.isArray(saved)) return JSON.parse(JSON.stringify(DEFAULT_FOODS));
  const m = new Map(saved.map(x=>[x.id,x]));
  for (const f of DEFAULT_FOODS){
    if (!m.has(f.id)) m.set(f.id, f);
  }
  return Array.from(m.values());
}
function saveFoods(arr){ saveJson(KEY_FOODS, arr); }

function loadState(){
  const s = loadJson(KEY_STATE);
  if (!s || !s.week || !s.targets) return null;
  if (!s.targets.calTolPct && s.targets.calTolPct !== 0) s.targets.calTolPct = 10;
  if (!s.ui) s.ui = { started: true };
  if (!s.hero) s.hero = JSON.parse(JSON.stringify(DEFAULT_STATE.hero));
  return s;
}
function saveState(s){ saveJson(KEY_STATE, s); }

function loadLog(){ return loadJson(KEY_LOG) || {}; }
function saveLog(l){ saveJson(KEY_LOG, l); }

/* ============================
   UTIL
   ============================ */
const clone = (x)=> JSON.parse(JSON.stringify(x));
const r0 = x => Math.round(x);
const r1 = x => Math.round((x + Number.EPSILON)*10)/10;

function isoDate(d=new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function formatDMY(d=new Date()){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function weekdayIdx(date=new Date()){
  // JS: 0=Sunday. We want 0=Monday..6=Sunday
  const js = date.getDay();
  return (js+6)%7;
}
function startOfWeek(date=new Date()){
  const d = new Date(date);
  const idx = weekdayIdx(d);
  d.setDate(d.getDate()-idx);
  d.setHours(0,0,0,0);
  return d;
}
function weekDates(date=new Date()){
  const start = startOfWeek(date);
  return Array.from({length:7},(_,i)=>{
    const d = new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escapeAttr(s){
  return String(s).replaceAll("&","&amp;").replaceAll('"',"&quot;");
}
function slugify(s){
  return String(s||"")
    .toLowerCase()
    .trim()
    .replace(/à|á|â|ã|ä/g,"a").replace(/è|é|ê|ë/g,"e")
    .replace(/ì|í|î|ï/g,"i").replace(/ò|ó|ô|õ|ö/g,"o")
    .replace(/ù|ú|û|ü/g,"u")
    .replace(/[^a-z0-9]+/g,"_")
    .replace(/^_+|_+$/g,"")
    .slice(0,40) || ("food_"+Math.random().toString(16).slice(2,8));
}
function clampNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

/* ============================
   MACRO CALC
   ============================ */
let foods = loadFoods();
let foodsById = new Map(foods.map(f=>[f.id,f]));
function rebuildFoodsMap(){ foodsById = new Map(foods.map(f=>[f.id,f])); }

function macrosForItem(food, grams){
  const mult = (Number(grams)||0)/100;
  return { kcal: food.kcal*mult, p: (food.p||0)*mult, c: (food.c||0)*mult, f: (food.f||0)*mult };
}
function sumMacros(list){
  return list.reduce((a,x)=>({kcal:a.kcal+(x.kcal||0), p:a.p+(x.p||0), c:a.c+(x.c||0), f:a.f+(x.f||0)}), {kcal:0,p:0,c:0,f:0});
}
function dayTotals(day){
  const perMeal = day.meals.map(meal=>{
    if (meal.free) return { meal, totals:{kcal:0,p:0,c:0,f:0} };
    const items = meal.items || [];
    const macros = items.map(it=>{
      const food = foodsById.get(it.foodId);
      return food ? macrosForItem(food, it.g) : {kcal:0,p:0,c:0,f:0};
    });
    return { meal, totals: sumMacros(macros) };
  });
  return { totals: sumMacros(perMeal.map(x=>x.totals)), perMeal };
}

// Regola: OK se calorie entro ±% del target (default 10%)
function kcalTolerance(targets){
  const pct = (targets.calTolPct ?? 10) / 100;
  return (targets.kcal||0) * pct;
}
function dayOk(totals, targets){
  const tol = kcalTolerance(targets);
  return Math.abs((totals.kcal||0) - (targets.kcal||0)) <= tol;
}
function statusForDay(totals, targets){
  if (dayOk(totals, targets)) return "ok";
  const tol = kcalTolerance(targets);
  const d = Math.abs((totals.kcal||0) - (targets.kcal||0));
  return d <= tol*2 ? "warn" : "bad";
}

function suggestAlternatives(targetMacros, currentFoodId, limit=8){
  const target = targetMacros;
  const out = [];
  for (const f of foods){
    if (f.id === currentFoodId) continue;
    if (!f.kcal || f.kcal <= 0) continue;
    const grams = (target.kcal / f.kcal) * 100;
    if (!Number.isFinite(grams) || grams <= 0) continue;
    if (grams > 1500) continue;
    const m = macrosForItem(f, grams);
    const diff = Math.abs(m.p-target.p) + Math.abs(m.c-target.c) + Math.abs(m.f-target.f);
    out.push({ food:f, grams, macros:m, diff });
  }
  out.sort((a,b)=>a.diff-b.diff);
  return out.slice(0, limit);
}

/* ============================
   UI STATE
   ============================ */
let state = loadState() || clone(DEFAULT_STATE);
let log = loadLog();
let activeTab = "home";
let editingDayIdx = null;

const content = document.getElementById("content");
const tabHome = document.getElementById("tab-home");
const tabWeek = document.getElementById("tab-settimana");
const tabSettings = document.getElementById("tab-impostazioni");
const tabStats = document.getElementById("tab-statistiche");

function setTab(t){
  activeTab = t;
  tabHome.setAttribute("aria-selected", t==="home");
  tabWeek.setAttribute("aria-selected", t==="settimana");
  tabSettings.setAttribute("aria-selected", t==="impostazioni");
  tabStats.setAttribute("aria-selected", t==="statistiche");
  render();
}
tabHome.onclick = ()=>setTab("home");
tabWeek.onclick = ()=>setTab("settimana");
tabSettings.onclick = ()=>setTab("impostazioni");
tabStats.onclick = ()=>setTab("statistiche");

/* ============================
   RENDER HELPERS
   ============================ */
function pill(status, text){
  const cls = status==="ok" ? "pill pillOk" : (status==="warn" ? "pill pillWarn" : "pill pillBad");
  return `<span class="${cls}">${text}</span>`;
}
function kpiBox(label, val, target, tol){
  const diff = val - target;
  const ok = Math.abs(diff) <= tol;
  const st = ok ? "ok" : (Math.abs(diff) <= tol*2 ? "warn" : "bad");
  const badge = ok ? "OK" : (diff>0 ? `+${r1(diff)}` : `${r1(diff)}`);
  return `
    <div class="kpiBox">
      <div class="kpiLabel">${label}</div>
      <div class="kpiVal mono">${val}</div>
      <div class="rowBetween" style="margin-top:6px;">
        <div class="small">Target: <span class="mono">${target}</span> ± <span class="mono">${r0(tol)}</span></div>
        ${pill(st, badge)}
      </div>
    </div>
  `;
}

function summaryWeekPlan(){
  // Valuta la settimana del piano (non storico): utile per capire quanto è "centrato" il piano attuale
  const days = state.week.map(d=>{
    const totals = dayTotals(d).totals;
    const ok = dayOk(totals, state.targets);
    const st = statusForDay(totals, state.targets);
    return { day:d, totals, ok, st };
  });
  return { days, okDays: days.filter(x=>x.ok).length, totalDays: days.length };
}

function summaryWeekHistory(date=new Date()){
  // Settimana corrente (lun-dom) basata sullo storico automatico
  const dates = weekDates(date);
  const days = dates.map((d,i)=>{
    const key = isoDate(d);
    const entry = log[key] || null;
    const ok = entry ? !!entry.ok : null;
    return { date:d, key, ok, entry };
  });
  const withData = days.filter(x=>x.ok!==null);
  const okCount = days.filter(x=>x.ok===true).length;
  return { days, okCount, totalWithData: withData.length };
}

function updateAutoLog(){
  const todayIdx = weekdayIdx(new Date());
  const todayPlan = state.week[todayIdx] || state.week[0];
  const totals = dayTotals(todayPlan).totals;
  const ok = dayOk(totals, state.targets);
  const key = isoDate(new Date());
  log[key] = {
    ok,
    kcal: r0(totals.kcal),
    p: r1(totals.p),
    c: r1(totals.c),
    f: r1(totals.f),
    targetKcal: state.targets.kcal,
    tolPct: state.targets.calTolPct ?? 10,
    at: new Date().toISOString()
  };
}

/* ============================
   MAIN RENDER
   ============================ */
function render(){
  // aggiorna log automatico (app decide OK/NO)
  updateAutoLog();

  saveState(state);
  saveLog(log);
  saveFoods(foods);

  const today = new Date();
  const todayIdx = weekdayIdx(today);
  const weekDatesArr = weekDates(today);
  const todayDate = weekDatesArr[todayIdx];

  const wkPlan = summaryWeekPlan();
  const todayPlan = wkPlan.days[todayIdx] || wkPlan.days[0];
  const totalsToday = todayPlan ? todayPlan.totals : {kcal:0,p:0,c:0,f:0};

  const tolKcal = kcalTolerance(state.targets);
  const status = todayPlan ? todayPlan.st : "warn";
  const statusLabel = status==="ok" ? "Giornata OK" : (status==="warn" ? "Quasi in target" : "Fuori target");
  const statusDetail = (() => {
    const diff = r0((totalsToday.kcal||0) - (state.targets.kcal||0));
    const sign = diff>0 ? "+" : "";
    return `${r0(totalsToday.kcal)} kcal (target ${state.targets.kcal} ± ${r0(tolKcal)} → ${sign}${diff})`;
  })();

  const leftCard = `
    <div class="card">
      <div class="rowBetween">
        <div>
          <h2 style="margin-bottom:6px;">Oggi</h2>
          <div class="muted"><b>${todayPlan?.day.dayName || ""}</b> — ${formatDMY(todayDate)}</div>
        </div>
        ${pill(status, statusLabel)}
      </div>

      <div class="hr"></div>

      <div class="kpi">
        ${kpiBox("Kcal", r0(totalsToday.kcal), state.targets.kcal, tolKcal)}
        ${kpiBox("Proteine", r1(totalsToday.p), 0, 0)}
        ${kpiBox("Carbo", r1(totalsToday.c), 0, 0)}
        ${kpiBox("Grassi", r1(totalsToday.f), 0, 0)}
      </div>

      <div class="hr"></div>

      <div class="rowBetween">
        <div class="muted">
          Stato: <b>${statusDetail}</b>
          <div class="small">Regola OK: calorie entro ±${state.targets.calTolPct ?? 10}%</div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn btnPrimary" id="openToday">Apri pasti di oggi</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="toast">
        Suggerimento: se sostituisci un alimento, usa “Suggerimenti” per alternative con grammature simili.
      </div>
    </div>
  `;

  let rightCard = "";
  if (!state.ui.started){
    rightCard = renderOnboarding();
  } else if (activeTab === "home"){
    rightCard = renderHome(wkPlan, todayIdx, todayDate);
  } else if (activeTab === "settimana"){
    rightCard = renderWeek(wkPlan, weekDatesArr);
  } else if (activeTab === "impostazioni"){
    rightCard = renderSettings();
  } else {
    rightCard = renderStats(today);
  }

  content.innerHTML = leftCard + rightCard;

  // binds
  const openBtn = document.getElementById("openToday");
  if (openBtn) openBtn.onclick = ()=>openEditor(todayIdx, weekDatesArr[todayIdx]);

  if (activeTab === "impostazioni" && state.ui.started){
    bindSettings();
  }
  if (!state.ui.started){
    bindOnboarding();
  }
  if (activeTab === "home" && state.ui.started){
    bindHome();
  }
}

function renderOnboarding(){
  const imgStyle = state.hero.photo ? `style="background-image:url('${escapeAttr(state.hero.photo)}')"` : `style="background-image:linear-gradient(135deg, rgba(34,197,94,.35), rgba(15,23,42,.2))"`;
  return `
    <div class="card">
      <h2>Prima configurazione</h2>
      <div class="muted">Imposta i tuoi parametri, scegli una foto motivazionale e poi entra nell’app.</div>
      <div class="hr"></div>

      <div class="hero">
        <div class="heroTop">
          <div class="heroImg" ${imgStyle}></div>
          <div class="heroShade"></div>
          <div class="heroContent">
            <div class="heroTitle">${escapeHtml(state.hero.title || "")}</div>
            <div class="heroQuote">“${escapeHtml(state.hero.quote || "")}”</div>
          </div>
        </div>
        <div class="heroActions">
          <span class="chip">Obiettivo: <b class="mono">${state.targets.kcal}</b> kcal</span>
          <span class="chip">Tolleranza: <b class="mono">±${state.targets.calTolPct ?? 10}%</b></span>
          <span class="chip">Sgarro: modificabile</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="formGrid">
        <div>
          <div class="label">Kcal target (coach)</div>
          <input class="input mono" id="obKcal" inputmode="numeric" value="${state.targets.kcal}">
        </div>
        <div>
          <div class="label">Tolleranza calorie (±%)</div>
          <input class="input mono" id="obTolPct" inputmode="numeric" value="${state.targets.calTolPct ?? 10}">
        </div>

        <div>
          <div class="label">Titolo motivazionale</div>
          <input class="input" id="heroTitle" value="${escapeAttr(state.hero.title || "")}">
        </div>
        <div>
          <div class="label">Testo motivazionale</div>
          <input class="input" id="heroQuote" value="${escapeAttr(state.hero.quote || "")}">
        </div>

        <div>
          <div class="label">Foto (caricamento)</div>
          <input class="input" type="file" id="heroPhoto" accept="image/*">
          <div class="small">Consiglio: scegli una foto chiara, verticale.</div>
        </div>
        <div>
          <div class="label">Anteprima</div>
          <div class="heroTop" style="min-height:120px;border:1px solid var(--line);border-radius:14px;overflow:hidden">
            <div class="heroImg" ${imgStyle}></div>
            <div class="heroShade"></div>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn btnPrimary" id="enterApp">Entra nell’app</button>
        <button class="btn" id="skipApp">Salta (puoi modificare dopo)</button>
      </div>

      <div class="hr"></div>
      <div class="footnote">
        Nota: questa app non traccia “consumi reali”. Calcola l’aderenza sulla base del piano (grammi) inserito. Se modifichi i pasti, lo stato giornaliero cambia automaticamente.
      </div>
    </div>
  `;
}

function renderHome(wkPlan, todayIdx, todayDate){
  const hist = summaryWeekHistory(new Date());
  const weekLabel = `Settimana (storico): ${hist.okCount} OK su ${hist.totalWithData || 0} giorni registrati`;

  const imgStyle = state.hero.photo ? `style="background-image:url('${escapeAttr(state.hero.photo)}')"` : `style="background-image:linear-gradient(135deg, rgba(34,197,94,.35), rgba(15,23,42,.2))"`;

  return `
    <div class="card">
      <h2>Dashboard</h2>
      <div class="muted">Qui trovi motivazione e scorciatoie operative.</div>

      <div class="hr"></div>

      <div class="hero">
        <div class="heroTop">
          <div class="heroImg" ${imgStyle}></div>
          <div class="heroShade"></div>
          <div class="heroContent">
            <div class="heroTitle">${escapeHtml(state.hero.title || "")}</div>
            <div class="heroQuote">“${escapeHtml(state.hero.quote || "")}”</div>
          </div>
        </div>
        <div class="heroActions">
          <button class="btn btnPrimary" id="homeOpenToday">Apri oggi</button>
          <button class="btn" id="homeEditHero">Modifica motivazione</button>
          <button class="btn" id="homeGoSettings">Macro</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="rowBetween">
        <div>
          <div style="font-weight:950">Aderenza automatica</div>
          <div class="small">${weekLabel}</div>
        </div>
        <div class="small">Oggi: <span class="mono">${formatDMY(todayDate)}</span></div>
      </div>

      <div class="hr"></div>

      <div class="footnote">
        “Giornata OK” = calorie entro ±${state.targets.calTolPct ?? 10}% del target. I pasti “Sgarro” non vengono conteggiati.
      </div>
    </div>
  `;
}

function renderWeek(wkPlan, weekDatesArr){
  const list = wkPlan.days.map((x, idx)=>{
    const label = x.ok ? "OK" : (x.st==="warn" ? "Quasi" : "Fuori");
    const d = weekDatesArr[idx];
    const dm = `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`;
    return `
      <div class="dayCard" data-day="${idx}">
        <div class="dayHead">
          <div>
            <div style="font-weight:950">${x.day.dayName} <span class="small mono">(${dm})</span></div>
            <div class="small mono">Totali: ${r0(x.totals.kcal)} kcal</div>
          </div>
          ${pill(x.st, label)}
        </div>
      </div>
    `;
  }).join("");

  const card = `
    <div class="card">
      <h2>Settimana (piano)</h2>
      <div class="muted">
        Tocca una giornata per modificare pasti, alimenti e grammi. Puoi aggiungere/rimuovere pasti e impostare lo sgarro su qualunque pasto.
      </div>
      <div class="hr"></div>
      <div class="rowBetween">
        <div class="muted">Giorni OK (piano): <b>${wkPlan.okDays}</b> / ${wkPlan.totalDays}</div>
        <button class="btn btnDanger" id="resetPlan">Reset piano</button>
      </div>
      <div class="hr"></div>
      <div class="dayList">${list}</div>
    </div>
  `;

  setTimeout(()=>{
    const resetBtn = document.getElementById("resetPlan");
    if (resetBtn) resetBtn.onclick = ()=>{
      if (confirm("Vuoi ripristinare il piano predefinito?")) {
        state = clone(DEFAULT_STATE);
        foods = clone(DEFAULT_FOODS);
        rebuildFoodsMap();
        render();
      }
    };
    document.querySelectorAll("[data-day]").forEach(el=>{
      el.onclick = ()=>{
        const idx = Number(el.getAttribute("data-day"));
        openEditor(idx, weekDatesArr[idx]);
      };
    });
  }, 0);

  return card;
}

function renderSettings(){
  const t = state.targets;
  const foodsHtml = foods
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(f=>{
      const isDefault = DEFAULT_FOODS.some(d=>d.id===f.id);
      return `
        <div class="rowBetween" style="padding:8px 0;border-bottom:1px solid var(--line);">
          <div>
            <div style="font-weight:950">${escapeHtml(f.name)} <span class="small mono">(${escapeHtml(f.id)})</span></div>
            <div class="small mono">kcal ${f.kcal} — P ${f.p} — C ${f.c} — F ${f.f} (per 100g)</div>
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn" data-food-action="edit" data-id="${escapeAttr(f.id)}">Modifica</button>
            ${isDefault ? "" : `<button class="btn btnDanger" data-food-action="del" data-id="${escapeAttr(f.id)}">Elimina</button>`}
          </div>
        </div>
      `;
    }).join("");

  return `
    <div class="card">
      <h2>Impostazioni</h2>
      <div class="muted">Macro “OK/NO” calcolati automaticamente sulle calorie (±%).</div>
      <div class="hr"></div>

      <div class="formGrid">
        <div>
          <div class="label">Kcal target</div>
          <input class="input mono" id="kcal" inputmode="numeric" value="${t.kcal}">
        </div>
        <div>
          <div class="label">Tolleranza calorie (±%)</div>
          <input class="input mono" id="calTolPct" inputmode="numeric" value="${t.calTolPct ?? 10}">
          <div class="small">Equivalente: ±<span class="mono">${r0(kcalTolerance(t))}</span> kcal</div>
        </div>

        <div style="grid-column:1/-1">
          <div class="label">Motivazione (testo)</div>
          <textarea class="input" id="heroQuote2">${escapeHtml(state.hero.quote || "")}</textarea>
          <div class="small">Suggerimento: una frase breve, concreta.</div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn btnPrimary" id="saveTargets">Salva</button>
        <button class="btn" id="goOnboarding">Apri schermata iniziale</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0">Database alimenti</h2>
      <div class="muted">Se non trovi un alimento nel menu, aggiungilo qui (valori per 100g).</div>
      <div class="hr"></div>

      <div class="formGrid">
        <div>
          <div class="label">Nome alimento</div>
          <input class="input" id="newFoodName" placeholder="Es. Pane integrale" />
        </div>
        <div>
          <div class="label">ID (opzionale)</div>
          <input class="input mono" id="newFoodId" placeholder="pane_integrale" />
        </div>

        <div>
          <div class="label">Kcal / 100g</div>
          <input class="input mono" id="newFoodKcal" inputmode="numeric" placeholder="250" />
        </div>
        <div>
          <div class="label">Proteine / 100g</div>
          <input class="input mono" id="newFoodP" inputmode="numeric" placeholder="10" />
        </div>

        <div>
          <div class="label">Carbo / 100g</div>
          <input class="input mono" id="newFoodC" inputmode="numeric" placeholder="50" />
        </div>
        <div>
          <div class="label">Grassi / 100g</div>
          <input class="input mono" id="newFoodF" inputmode="numeric" placeholder="5" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btnPrimary" id="addFood">Aggiungi alimento</button>
        <button class="btn" id="restoreFoods">Ripristina alimenti base</button>
      </div>

      <div class="hr"></div>
      <div class="muted" id="foodsList">${foodsHtml || "Nessun alimento."}</div>

      <div class="hr"></div>
      <div class="footnote">
        Nota: per ora l’aderenza è basata sulle calorie. Se vuoi, nel prossimo step aggiungiamo anche regole su P/C/F.
      </div>
    </div>
  `;
}

function renderStats(now=new Date()){
  const entries = Object.entries(log || {}).sort((a,b)=>a[0].localeCompare(b[0]));
  const total = entries.length;
  const ok = entries.filter(([,v])=>v.ok).length;

  const byMonth = new Map();
  const byYear = new Map();
  for (const [d, v] of entries){
    const ym = d.slice(0,7);
    const y = d.slice(0,4);
    byMonth.set(ym, { ok:(byMonth.get(ym)?.ok||0)+(v.ok?1:0), total:(byMonth.get(ym)?.total||0)+1 });
    byYear.set(y, { ok:(byYear.get(y)?.ok||0)+(v.ok?1:0), total:(byYear.get(y)?.total||0)+1 });
  }
  const months = Array.from(byMonth.entries()).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,10);
  const years = Array.from(byYear.entries()).sort((a,b)=>b[0].localeCompare(a[0]));

  const monthsHtml = months.length ? months.map(([k,v])=>(
    `<div class="rowBetween" style="padding:6px 0"><span class="mono">${k}</span>${pill("ok", `${v.ok}/${v.total}`)}</div>`
  )).join("") : `<div class="muted">Nessun dato.</div>`;

  const yearsHtml = years.length ? years.map(([k,v])=>(
    `<div class="rowBetween" style="padding:6px 0"><span class="mono">${k}</span>${pill("ok", `${v.ok}/${v.total}`)}</div>`
  )).join("") : `<div class="muted">Nessun dato.</div>`;

  const weekHist = summaryWeekHistory(now);
  const weekRange = (() => {
    const start = startOfWeek(now);
    const end = new Date(start); end.setDate(start.getDate()+6);
    return `${formatDMY(start)} → ${formatDMY(end)}`;
  })();

  const card = `
    <div class="card">
      <h2>Statistiche</h2>
      <div class="muted">
        Lo storico viene aggiornato automaticamente in base al piano del giorno.
      </div>

      <div class="hr"></div>

      <div class="rowBetween">
        <div>
          <div style="font-weight:950">Settimana corrente</div>
          <div class="small">${weekRange} — OK: <b>${weekHist.okCount}</b> / <b>${weekHist.totalWithData}</b> giorni registrati</div>
        </div>
        <button class="btn btnDanger" id="resetLog">Azzera storico</button>
      </div>

      <div class="hr"></div>

      <div class="rowBetween">
        <div>
          <div style="font-weight:950">Totale storico</div>
          <div class="small">Giorni registrati: <b>${total}</b> — OK: <b>${ok}</b></div>
        </div>
        <div class="small">Oggi: <span class="mono">${isoDate(now)}</span></div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:14px;align-items:flex-start">
        <div style="flex:1;min-width:240px">
          <div style="font-weight:950;margin-bottom:6px">Ultimi mesi</div>
          ${monthsHtml}
        </div>
        <div style="flex:1;min-width:240px">
          <div style="font-weight:950;margin-bottom:6px">Anni</div>
          ${yearsHtml}
        </div>
      </div>

      <div class="hr"></div>
      <div class="footnote">
        OK = calorie entro ±${state.targets.calTolPct ?? 10}%. Se modifichi il piano di un giorno, lo stato può cambiare.
      </div>
    </div>
  `;

  setTimeout(()=>{
    const btn = document.getElementById("resetLog");
    if (btn) btn.onclick = ()=>{
      if (confirm("Vuoi azzerare lo storico?")) { log = {}; render(); }
    };
  }, 0);

  return card;
}

/* ============================
   BINDINGS: HOME + ONBOARDING + SETTINGS
   ============================ */
function bindHome(){
  const todayIdx = weekdayIdx(new Date());
  const dates = weekDates(new Date());
  const b1 = document.getElementById("homeOpenToday");
  if (b1) b1.onclick = ()=>openEditor(todayIdx, dates[todayIdx]);

  const b2 = document.getElementById("homeEditHero");
  if (b2) b2.onclick = ()=>setTab("impostazioni");

  const b3 = document.getElementById("homeGoSettings");
  if (b3) b3.onclick = ()=>setTab("impostazioni");
}

function bindOnboarding(){
  const obKcal = document.getElementById("obKcal");
  const obTol = document.getElementById("obTolPct");
  const ht = document.getElementById("heroTitle");
  const hq = document.getElementById("heroQuote");
  const hp = document.getElementById("heroPhoto");

  const sync = ()=>{
    state.targets.kcal = clampNum(obKcal.value) || state.targets.kcal;
    state.targets.calTolPct = clampNum(obTol.value) || 10;
    state.hero.title = ht.value;
    state.hero.quote = hq.value;
    saveState(state);
    render();
  };
  obKcal.onchange = sync;
  obTol.onchange = sync;
  ht.onchange = sync;
  hq.onchange = sync;

  if (hp){
    hp.onchange = async ()=>{
      const file = hp.files && hp.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        state.hero.photo = String(reader.result || "");
        saveState(state);
        render();
      };
      reader.readAsDataURL(file);
    };
  }

  const enter = document.getElementById("enterApp");
  if (enter) enter.onclick = ()=>{
    state.ui.started = true;
    saveState(state);
    setTab("home");
  };

  const skip = document.getElementById("skipApp");
  if (skip) skip.onclick = ()=>{
    state.ui.started = true;
    saveState(state);
    setTab("home");
  };
}

function bindSettings(){
  const kcal = document.getElementById("kcal");
  const calTolPct = document.getElementById("calTolPct");
  const heroQuote2 = document.getElementById("heroQuote2");
  const saveBtn = document.getElementById("saveTargets");
  const goOnb = document.getElementById("goOnboarding");

  if (saveBtn){
    saveBtn.onclick = ()=>{
      state.targets.kcal = clampNum(kcal.value) || state.targets.kcal;
      state.targets.calTolPct = clampNum(calTolPct.value) || 10;
      state.hero.quote = heroQuote2.value;
      saveState(state);
      alert("Salvato.");
      render();
    };
  }

  if (goOnb){
    goOnb.onclick = ()=>{
      state.ui.started = false;
      saveState(state);
      setTab("home");
    };
  }

  // Foods
  const addBtn = document.getElementById("addFood");
  const restoreBtn = document.getElementById("restoreFoods");

  function refreshFoods(){
    rebuildFoodsMap();
    saveFoods(foods);
    render();
    if (editingDayIdx !== null) renderEditor(); // keep modal synced
  }

  if (addBtn){
    addBtn.onclick = ()=>{
      const name = document.getElementById("newFoodName").value.trim();
      const idRaw = document.getElementById("newFoodId").value.trim();
      const kcal = clampNum(document.getElementById("newFoodKcal").value);
      const p = clampNum(document.getElementById("newFoodP").value);
      const c = clampNum(document.getElementById("newFoodC").value);
      const f = clampNum(document.getElementById("newFoodF").value);

      if (!name){ alert("Inserisci il nome alimento."); return; }
      if (!kcal && !p && !c && !f){ alert("Inserisci almeno un valore macro."); return; }

      const id = idRaw ? slugify(idRaw) : slugify(name);
      if (foodsById.has(id)){
        alert("Esiste già un alimento con questo ID.");
        return;
      }
      foods.push({ id, name, kcal, p, c, f });
      refreshFoods();
      alert("Alimento aggiunto.");
    };
  }

  if (restoreBtn){
    restoreBtn.onclick = ()=>{
      if (!confirm("Vuoi ripristinare gli alimenti base? I personalizzati verranno rimossi.")) return;
      foods = clone(DEFAULT_FOODS);
      refreshFoods();
    };
  }

  document.querySelectorAll("[data-food-action]").forEach(btn=>{
    btn.onclick = ()=>{
      const action = btn.getAttribute("data-food-action");
      const id = btn.getAttribute("data-id");
      const idx = foods.findIndex(x=>x.id===id);
      if (idx < 0) return;
      const isDefault = DEFAULT_FOODS.some(d=>d.id===id);

      if (action === "del"){
        if (isDefault) return;
        if (confirm("Eliminare questo alimento?")) {
          foods.splice(idx,1);
          refreshFoods();
        }
        return;
      }
      if (action === "edit"){
        const f0 = foods[idx];
        const newName = prompt("Nome alimento:", f0.name);
        if (newName === null) return;
        const newK = prompt("Kcal per 100g:", String(f0.kcal ?? 0));
        if (newK === null) return;
        const newP = prompt("Proteine per 100g:", String(f0.p ?? 0));
        if (newP === null) return;
        const newC = prompt("Carbo per 100g:", String(f0.c ?? 0));
        if (newC === null) return;
        const newF = prompt("Grassi per 100g:", String(f0.f ?? 0));
        if (newF === null) return;

        foods[idx] = {
          ...f0,
          name: String(newName).trim() || f0.name,
          kcal: clampNum(newK),
          p: clampNum(newP),
          c: clampNum(newC),
          f: clampNum(newF),
        };
        refreshFoods();
      }
    };
  });
}

/* ============================
   EDITOR MODAL
   ============================ */
const dlg = document.getElementById("editor");
const editorTitle = document.getElementById("editorTitle");
const mealList = document.getElementById("mealList");
let editingDate = null;

document.getElementById("closeEditor").onclick = ()=>dlg.close();

document.getElementById("addMeal").onclick = ()=>{
  if (editingDayIdx==null) return;
  state.week[editingDayIdx].meals.push({ name:"Nuovo pasto", free:false, items:[{foodId:foods[0].id,g:100}] });
  renderEditor();
  render();
};

const inlineForm = document.getElementById("inlineFoodForm");
document.getElementById("addFoodInline").onclick = ()=>{
  inlineForm.style.display = (inlineForm.style.display === "none") ? "block" : "none";
};
document.getElementById("ifCancel").onclick = ()=>{ inlineForm.style.display = "none"; };

document.getElementById("ifSave").onclick = ()=>{
  const name = document.getElementById("ifName").value.trim();
  const idRaw = document.getElementById("ifId").value.trim();
  const kcal = clampNum(document.getElementById("ifKcal").value);
  const p = clampNum(document.getElementById("ifP").value);
  const c = clampNum(document.getElementById("ifC").value);
  const f = clampNum(document.getElementById("ifF").value);

  if (!name){ alert("Inserisci il nome alimento."); return; }
  if (!kcal && !p && !c && !f){ alert("Inserisci almeno un valore macro."); return; }

  const id = idRaw ? slugify(idRaw) : slugify(name);
  if (foodsById.has(id)){
    alert("Esiste già un alimento con questo ID.");
    return;
  }
  foods.push({ id, name, kcal, p, c, f });
  saveFoods(foods);
  rebuildFoodsMap();
  inlineForm.style.display = "none";
  alert("Alimento aggiunto.");
  renderEditor();
  render();
};

function openEditor(dayIdx, dateObj=null){
  editingDayIdx = dayIdx;
  editingDate = dateObj;
  renderEditor();
  dlg.showModal();
}

function foodOptions(selectedId){
  return foods
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(f=>`<option value="${escapeAttr(f.id)}" ${f.id===selectedId?"selected":""}>${escapeHtml(f.name)}</option>`)
    .join("");
}

function renderEditor(){
  const day = state.week[editingDayIdx];
  const dateStr = editingDate ? ` — ${formatDMY(editingDate)}` : "";
  editorTitle.textContent = `Pasti: ${day.dayName}${dateStr}`;

  const html = day.meals.map((meal, mi)=>{
    const itemsHtml = (meal.items||[]).map((it, ii)=>{
      return `
        <div>
          <div class="itemRow">
            <select class="input" data-mi="${mi}" data-ii="${ii}" data-field="foodId">${foodOptions(it.foodId)}</select>
            <input class="input mono" inputmode="numeric" data-mi="${mi}" data-ii="${ii}" data-field="g" value="${it.g}">
            <button class="btn" data-mi="${mi}" data-ii="${ii}" data-action="suggest">Suggerimenti</button>
            <button class="btn btnDanger" data-mi="${mi}" data-ii="${ii}" data-action="rmItem">×</button>
          </div>
          <div class="suggestBox" id="sug-${mi}-${ii}" style="display:none"></div>
        </div>
      `;
    }).join("");

    return `
      <div class="meal">
        <div class="mealHead">
          <div class="row" style="flex:1;gap:8px;min-width:240px">
            <input class="input" data-mi="${mi}" data-field="name" value="${escapeAttr(meal.name)}" style="flex:1">
            <label class="row" style="gap:6px">
              <input type="checkbox" data-mi="${mi}" data-field="free" ${meal.free?"checked":""}>
              <span class="small">Sgarro</span>
            </label>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn" data-mi="${mi}" data-action="addItem">+ Alimento</button>
            <button class="btn btnDanger" data-mi="${mi}" data-action="rmMeal">Rimuovi pasto</button>
          </div>
        </div>
        <div class="items">${itemsHtml}</div>
      </div>
    `;
  }).join("");

  mealList.innerHTML = html;

  mealList.querySelectorAll("[data-field]").forEach(el=>{
    el.onchange = ()=>{
      const mi = Number(el.getAttribute("data-mi"));
      const ii = el.hasAttribute("data-ii") ? Number(el.getAttribute("data-ii")) : null;
      const field = el.getAttribute("data-field");
      if (field === "name"){
        state.week[editingDayIdx].meals[mi].name = el.value;
      } else if (field === "free"){
        state.week[editingDayIdx].meals[mi].free = el.checked;
      } else if (field === "foodId"){
        state.week[editingDayIdx].meals[mi].items[ii].foodId = el.value;
        const box = document.getElementById(`sug-${mi}-${ii}`);
        if (box) box.style.display = "none";
      } else if (field === "g"){
        state.week[editingDayIdx].meals[mi].items[ii].g = Number(el.value)||0;
        const box = document.getElementById(`sug-${mi}-${ii}`);
        if (box) box.style.display = "none";
      }
      saveState(state);
      render();
    };
  });

  mealList.querySelectorAll("[data-action]").forEach(btn=>{
    btn.onclick = ()=>{
      const action = btn.getAttribute("data-action");
      const mi = Number(btn.getAttribute("data-mi"));
      const ii = btn.hasAttribute("data-ii") ? Number(btn.getAttribute("data-ii")) : null;

      if (action === "addItem"){
        state.week[editingDayIdx].meals[mi].items.push({foodId:foods[0].id,g:100});
        saveState(state);
        renderEditor();
        render();
        return;
      }
      if (action === "rmMeal"){
        state.week[editingDayIdx].meals.splice(mi,1);
        saveState(state);
        renderEditor();
        render();
        return;
      }
      if (action === "rmItem"){
        state.week[editingDayIdx].meals[mi].items.splice(ii,1);
        saveState(state);
        renderEditor();
        render();
        return;
      }
      if (action === "suggest"){
        toggleSuggestions(mi, ii);
        return;
      }
    };
  });
}

function toggleSuggestions(mi, ii){
  const box = document.getElementById(`sug-${mi}-${ii}`);
  if (!box) return;

  const item = state.week[editingDayIdx].meals[mi].items[ii];
  const food = foodsById.get(item.foodId);
  if (!food){
    box.innerHTML = "<div class='muted'>Alimento non trovato.</div>";
    box.style.display = "block";
    return;
  }

  if (box.style.display === "block"){
    box.style.display = "none";
    return;
  }

  const target = macrosForItem(food, item.g);
  const suggestions = suggestAlternatives(target, item.foodId, 8);

  const header = `
    <div class="rowBetween">
      <div>
        <div style="font-weight:950">Sostituzioni (match kcal)</div>
        <div class="small mono">Target: ${r0(target.kcal)} kcal — P ${r1(target.p)} — C ${r1(target.c)} — F ${r1(target.f)}</div>
      </div>
      <button class="btn" id="closeSug-${mi}-${ii}">Chiudi</button>
    </div>
    <div class="hr"></div>
    <div class="muted">Tocca “Applica” per sostituire l’alimento e impostare i grammi suggeriti.</div>
  `;

  const rows = suggestions.length ? suggestions.map(s=>{
    const dp = r1(s.macros.p - target.p);
    const dc = r1(s.macros.c - target.c);
    const df = r1(s.macros.f - target.f);
    const diffLabel = `ΔP ${dp>=0?'+':''}${dp} — ΔC ${dc>=0?'+':''}${dc} — ΔF ${df>=0?'+':''}${df}`;
    return `
      <div class="suggestRow">
        <div style="flex:1">
          <div style="font-weight:950">${escapeHtml(s.food.name)}</div>
          <div class="small mono">${r0(s.grams)} g — ${diffLabel}</div>
        </div>
        <button class="btn btnPrimary" data-apply-food="${escapeAttr(s.food.id)}" data-apply-g="${r0(s.grams)}">Applica</button>
      </div>
    `;
  }).join("") : `<div class="muted">Nessun suggerimento disponibile.</div>`;

  box.innerHTML = header + `<div class="suggestGrid">${rows}</div>`;
  box.style.display = "block";

  document.getElementById(`closeSug-${mi}-${ii}`).onclick = ()=>{ box.style.display = "none"; };
  box.querySelectorAll("[data-apply-food]").forEach(b=>{
    b.onclick = ()=>{
      const fid = b.getAttribute("data-apply-food");
      const g = Number(b.getAttribute("data-apply-g")) || 0;
      item.foodId = fid;
      item.g = g;
      saveState(state);
      box.style.display = "none";
      renderEditor();
      render();
    };
  });
}

/* START */
setTab(state.ui.started ? "home" : "home");
render();
</script>
</body>
</html>
